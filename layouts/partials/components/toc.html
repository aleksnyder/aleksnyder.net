{{/* ignore empty links with + */}}
{{- $headers := findRE "<h[2-4].*?>(.|\n])+?</h[2-4]>" .Content -}}
{{ .Scratch.Set "last_level" 1 }}

{{/* at least one header to link to */}}
{{- $has_headers := ge (len $headers) 1 -}}
{{- if $has_headers -}}
<aside class="sidebar">
    <div class="table-of-contents callout">
        <h2 class="toc__title">On this page</h2>
        <nav>
            {{- range $headers -}}
                {{- $header := . -}}
                {{- $clean_header := replace $header "#<" "<" -}}
                {{- $base := ($.Page.File.LogicalName) -}}
                {{- $anchorId := ($clean_header | plainify | htmlUnescape | anchorize) -}}
                {{- $href := delimit (slice $base $anchorId) "#" | string -}}
                {{- range findRE "[2-4]" . 1 -}}
                    {{- $next_heading := (int .) -}}
                    {{- if gt $next_heading ($.Scratch.Get "last_level") -}}
                        <ul class="toc">
                    {{- else if lt $next_heading ($.Scratch.Get "last_level") -}}
                        </ul>
                    {{- end -}}
                    <li><a class="toc__link" href="{{ relref $.Page $href }}">{{- $clean_header | plainify | htmlUnescape -}}</a></li>
                    {{ $.Scratch.Set "last_level" $next_heading }}
                {{- end -}}
            {{- end -}}
        </nav>
    </div>
</aside>
{{- end -}}